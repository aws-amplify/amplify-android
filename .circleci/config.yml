version: 2.1

commands:
  generate_gradle_wrapper:
    description: Download and install gradle wrapper
    steps:
      - run:
          name: Download gradle
          command: |
            cd ~
            wget https://services.gradle.org/distributions/gradle-5.6.2-bin.zip
            unzip gradle-5.6.2-bin.zip
      - run:
          name: Generate gradle wrapper
          command: |
            cd ~/amplify-android-home
            yes | sdkmanager --licenses && yes | sdkmanager --update
            ~/gradle-5.6.2/bin/gradle wrapper
  configure_aws:
    description: >-
      install aws cli and configure android aws release profile
    steps:
      - run:
          name: install aws cli
          command: |
            sudo pip install awscli
      - run:
          name: configure aws profile
          command: |
            aws configure --profile amplify_sdk_test set region us-east-1
            echo -e "[amplify_sdk_test]\naws_access_key_id=${AWS_ACCESS_KEY_ID_TEST}\naws_secret_access_key=${AWS_SECRET_ACCESS_KEY_TEST}\n" >> ~/.aws/credentials
jobs:
  build:
    working_directory: ~/amplify-android-home
    docker:
      - image: circleci/android:api-29
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - generate_gradle_wrapper
      - configure_aws
      - run:
          name: Build the project
          command: bash gradlew build
      - run:
          name: Publish the project to local maven
          command: bash gradlew publishToMavenLocal
      - store_test_results:
          path: test-results
  integrationtest:
    working_directory: ~/amplify-android-home
    docker:
      - image: circleci/android:api-29
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - generate_gradle_wrapper
      - run:
          name: Copy configuration files
          command: |
            aws s3 cp s3://amplify-circleci-android-payload1/awsconfiguration.json  aws-analytics-pinpoint/src/androidTest/res/raw/awsconfiguration.json --profile amplify_sdk_test 
            aws s3 cp s3://amplify-circleci-android-payload1/amplifyconfiguration.json  aws-analytics-pinpoint/src/androidTest/res/raw/amplifyconfiguration.json --profile amplify_sdk_test
      - run:
          name: Run integration test
          command: ./gradlew aws-analytics-pinpoint:cAT
workflows:
  build_test:
    jobs:
      - build:     
      - integrationtest:
          requires:
            - build          
          filters:
            branches:
              only:
                - master
                - roshan/circleCI
