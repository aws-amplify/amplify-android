name: Create PR for a release
on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Release from which branch?'
        required: true
        default: 'main'
      git_user_name:
        description: 'Git user name'
        required: true
        default: 'devops'
      git_user_email:
        description: 'Git user name'
        required: true
        default: 'devops@test.com'
jobs:
  create_pr_for_next_release:
    runs-on: ubuntu-latest
    steps:
    - name: Update git
      run: |
        sudo add-apt-repository -y ppa:git-core/ppa
        sudo apt-get update
        sudo apt-get install git -y
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.inputs.base_branch }}
        token: ${{ github.token }} # This will need to change to a token belonging to a service account.
        fetch-depth: 0
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.7
    - name: Install dependencies
      run: |
        cd scripts
        gem install bundler
        bundle install
    - name: Configure git options
      run: |
        cd scripts
        bundle exec fastlane android configure_git_options git_user_email:${{ github.event.inputs.git_user_email }} git_user_name:${{ github.event.inputs.git_user_name }}
    - name: Create/checkout a branch for the release
      run: |
        branch_name=release
        (git show-branch $branch_name &>/dev/null) && (git checkout $branch_name & git pull origin $branch_name) || (git checkout -b $branch_name)
    - name: Create PR for next release
      env:
        RELEASE_MANAGER_TOKEN: ${{ secrets.RELEASE_MANAGER_TOKEN }}
      run: |
        cd scripts
        bundle exec fastlane android manage_next_release_pr repo:${{ github.repository }} product_name:"Amplify Android"
    - name: Check modified file content
      run: |
        cat gradle.properties
        cat CHANGELOG.md
        git status
