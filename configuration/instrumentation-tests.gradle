
/*
Need to create backends for s3, pinpoint, predictions, core
 */
def module_backends = [
    'aws-datastore':'InstrumentedTests',
    'aws-api': 'ApiInstrumentedTests'
]

subprojects {
    afterEvaluate { project ->
        if (module_backends.containsKey(project.name)) {
            task runTestsInDeviceFarm {
                doLast {
                    exec {
                        commandLine("$rootDir.path/scripts/run_test_in_devicefarm.sh")
                        //TODO: Get the device pool in the script
                        args(["Single Google Pixel 3 XL (Android 10)", project.name])
                    }
                }
            }
        }
    }
}


task pullBackendConfigFromAmplify(description: "Pulls backend configurations from Amplify project.") {
    doLast {
        for(entry in module_backends) {
            def moduleName = entry.key
            def amplifyBackendProjectName = entry.value

            println("Getting config files for $amplifyBackendProjectName")
            def amplifyPullCommand =  "$rootDir.path/scripts/pull_backend_config_from_amplify.sh"
            exec {
                workingDir(rootDir.path)
                executable(amplifyPullCommand)
                args([amplifyBackendProjectName, moduleName])
                standardOutput(System.out)
            }
        }
    }
}