
/*
Need to create backends for s3, pinpoint, predictions, core
 */
def module_backends = [
    'aws-datastore':'DataStoreIntegTests',
    'aws-api': 'ApiInstrumentedTests',
    'aws-geo-location': 'GeoIntegTests',
    'maplibre-adapter': 'GeoIntegTests',
    'aws-storage-s3': 'NONE',
    'aws-analytics-pinpoint': 'NONE',
    'aws-predictions': 'NONE',
    'core':'NONE',
    'aws-auth-cognito': 'AuthIntegrationTests'
]

subprojects {
    afterEvaluate { project ->
        if (module_backends.containsKey(project.name)) {
            task runTestsInDeviceFarm {
                doLast {
                    exec {
                        commandLine("$rootDir.path/scripts/run_test_in_devicefarm.sh")
                        args([project.name])
                    }
                }
            }
            task runTestsInDeviceFarmPool {
                dependsOn(assembleAndroidTest)
                doLast {
                    exec {
                        commandLine("$rootDir.path/scripts/run_tests_in_devicefarm_pool.sh")
                        args([project.name])
                    }
                }
            }
            task runTestsExcludeStressTests {
                dependsOn(assembleAndroidTest)
                doLast {
                    useJUnit {
                        excludeCategories 'com.amplifyframework.testutils.junitcategories.StressTests'
                    }
                    exec {
                        commandLine("$rootDir.path/scripts/run_tests_in_devicefarm_pool.sh")
                        args([project.name])
                    }
                }
            }
        }
    }
}


task pullBackendConfigFromAmplify(description: "Pulls backend configurations from Amplify project.") {
    doLast {
        for(entry in module_backends) {
            def moduleName = entry.key
            def amplifyBackendProjectName = entry.value

            println("Getting config files for $amplifyBackendProjectName")
            def amplifyPullCommand =  "$rootDir.path/scripts/pull_backend_config_from_amplify"
            exec {
                workingDir(rootDir.path)
                executable(amplifyPullCommand)
                args([amplifyBackendProjectName, moduleName])
                standardOutput(System.out)
            }
        }
    }
}